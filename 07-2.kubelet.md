tags: worker, kubelet

# 07-2.éƒ¨ç½² kubelet ç»„ä»¶

<!-- TOC -->

- [07-2.éƒ¨ç½² kubelet ç»„ä»¶](#07-2éƒ¨ç½²-kubelet-ç»„ä»¶)
    - [ä¸‹è½½å’Œåˆ†å? kubelet äºŒè¿›åˆ¶æ–‡ä»¶](#ä¸‹è½½å’Œåˆ†å?-kubelet-äºŒè¿›åˆ¶æ–‡ä»?)
    - [å®‰è£…ä¾èµ–åŒ…](#å®‰è£…ä¾èµ–åŒ?)
    - [åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶](#åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶)
    - [åˆ†å‘ bootstrap kubeconfig æ–‡ä»¶åˆ°æ‰€æœ? worker èŠ‚ç‚¹](#åˆ†å‘-bootstrap-kubeconfig-æ–‡ä»¶åˆ°æ‰€æœ?-worker-èŠ‚ç‚¹)
    - [åˆ›å»ºå’Œåˆ†å? kubelet å‚æ•°é…ç½®æ–‡ä»¶](#åˆ›å»ºå’Œåˆ†å?-kubelet-å‚æ•°é…ç½®æ–‡ä»¶)
    - [åˆ›å»ºå’Œåˆ†å? kubelet systemd unit æ–‡ä»¶](#åˆ›å»ºå’Œåˆ†å?-kubelet-systemd-unit-æ–‡ä»¶)
    - [Bootstrap Token Auth å’Œæˆäºˆæƒé™](#bootstrap-token-auth-å’Œæˆäºˆæƒé™?)
    - [å¯åŠ¨ kubelet æœåŠ¡](#å¯åŠ¨-kubelet-æœåŠ¡)
    - [è‡ªåŠ¨ approve CSR è¯·æ±‚](#è‡ªåŠ¨-approve-csr-è¯·æ±‚)
    - [æŸ¥çœ‹ kublet çš„æƒ…å†µ](#æŸ¥çœ‹-kublet-çš„æƒ…å†?)
    - [æ‰‹åŠ¨ approve server cert csr](#æ‰‹åŠ¨-approve-server-cert-csr)
    - [kubelet æä¾›çš? API æ¥å£](#kubelet-æä¾›çš?-api-æ¥å£)
    - [kublet api è®¤è¯å’Œæˆæƒ](#kublet-api-è®¤è¯å’Œæˆæ?)
        - [è¯ä¹¦è®¤è¯å’Œæˆæƒ](#è¯ä¹¦è®¤è¯å’Œæˆæ?)
        - [bear token è®¤è¯å’Œæˆæƒ](#bear-token-è®¤è¯å’Œæˆæ?)
        - [cadvisor å’? metrics](#cadvisor-å’?-metrics)
    - [è·å– kublet çš„é…ç½®](#è·å–-kublet-çš„é…ç½?)
    - [å‚è?ƒ](#å‚è??)

<!-- /TOC -->
kublet è¿è¡Œåœ¨æ¯ä¸? worker èŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é?çš„è¯·æ±‚ï¼Œç®¡ç? Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã??

kublet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µã€?

ä¸ºç¡®ä¿å®‰å…¨ï¼Œæœ¬æ–‡æ¡£åªå¼?å¯æ¥æ”? https è¯·æ±‚çš„å®‰å…¨ç«¯å£ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œæ‹’ç»æœªæˆæƒçš„è®¿é—?(å¦? apiserverã€heapster)ã€?

æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡æ˜ï¼Œæœ¬æ–‡æ¡£çš„æ‰?æœ‰æ“ä½?**å‡åœ¨ m7-autocv-gpu01 èŠ‚ç‚¹ä¸Šæ‰§è¡?**ï¼Œç„¶åè¿œç¨‹åˆ†å‘æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ã€?

## ä¸‹è½½å’Œåˆ†å? kubelet äºŒè¿›åˆ¶æ–‡ä»?

å‚è?? [06-0.éƒ¨ç½²masterèŠ‚ç‚¹.md](06-0.éƒ¨ç½²masterèŠ‚ç‚¹.md)

## å®‰è£…ä¾èµ–åŒ?

å‚è?? [07-0.éƒ¨ç½²workerèŠ‚ç‚¹.md](07-0.éƒ¨ç½²workerèŠ‚ç‚¹.md)

## åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶

``` bash
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
for node_name in ${NODE_NAMES[@]}
  do
    echo ">>> ${node_name}"

    # åˆ›å»º token
    export BOOTSTRAP_TOKEN=$(kubeadm token create \
      --description kubelet-bootstrap-token \
      --groups system:bootstrappers:${node_name} \
      --kubeconfig ~/.kube/config)

    # è®¾ç½®é›†ç¾¤å‚æ•°
    kubectl config set-cluster kubernetes \
      --certificate-authority=/etc/kubernetes/cert/ca.pem \
      --embed-certs=true \
      --server=${KUBE_APISERVER} \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig

    # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•?
    kubectl config set-credentials kubelet-bootstrap \
      --token=${BOOTSTRAP_TOKEN} \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig

    # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•?
    kubectl config set-context default \
      --cluster=kubernetes \
      --user=kubelet-bootstrap \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig

    # è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–?
    kubectl config use-context default --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig
  done
```
+ è¯ä¹¦ä¸­å†™å…? Token è€Œéè¯ä¹¦ï¼Œè¯ä¹¦åç»­ç”± kube-controller-manager åˆ›å»ºã€?

æŸ¥çœ‹ kubeadm ä¸ºå„èŠ‚ç‚¹åˆ›å»ºçš? tokenï¼?

``` bash
$ kubeadm token list --kubeconfig ~/.kube/config
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS
c77gx4.fofw4ir1628c6zk8   23h       2018-11-29T16:54:27+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:m7-autocv-gpu01
em63m9.g4cemcarph6gz6vg   23h       2018-11-29T16:54:32+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:m7-autocv-gpu02
mnpn4i.iqttdxlan650stmu   23h       2018-11-29T16:54:35+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:m7-autocv-gpu03
```
+ åˆ›å»ºçš? token æœ‰æ•ˆæœŸä¸º 1 å¤©ï¼Œè¶…æœŸåå°†ä¸èƒ½å†è¢«ä½¿ç”¨ï¼Œä¸”ä¼šè¢« kube-controller-manager çš? tokencleaner æ¸…ç†(å¦‚æœå¯ç”¨è¯? controller çš„è¯)ï¼?
+ kube-apiserver æ¥æ”¶ kubelet çš? bootstrap token åï¼Œå°†è¯·æ±‚çš„ user è®¾ç½®ä¸? system:bootstrap:<Token ID>ï¼Œgroup è®¾ç½®ä¸? system:bootstrappersï¼?

æŸ¥çœ‹å? token å…³è”çš? Secretï¼?

``` bash
$ kubectl get secrets  -n kube-system|grep bootstrap-token
bootstrap-token-c77gx4                           bootstrap.kubernetes.io/token         7      54s
bootstrap-token-em63m9                           bootstrap.kubernetes.io/token         7      49s
bootstrap-token-mnpn4i                           bootstrap.kubernetes.io/token         7      46s
```

## åˆ†å‘ bootstrap kubeconfig æ–‡ä»¶åˆ°æ‰€æœ? worker èŠ‚ç‚¹

``` bash
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
for node_name in ${NODE_NAMES[@]}
  do
    echo ">>> ${node_name}"
    scp kubelet-bootstrap-${node_name}.kubeconfig root@${node_name}:/etc/kubernetes/kubelet-bootstrap.kubeconfig
  done
```

## åˆ›å»ºå’Œåˆ†å? kubelet å‚æ•°é…ç½®æ–‡ä»¶

ä»? v1.10 å¼?å§‹ï¼Œkubelet **éƒ¨åˆ†å‚æ•°**éœ?åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œ`kubelet --help` ä¼šæç¤ºï¼š

    DEPRECATED: This parameter should be set via the config file specified by the Kubelet's --config flag

åˆ›å»º kubelet å‚æ•°é…ç½®æ¨¡æ¿æ–‡ä»¶ï¼?

``` bash
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
cat <<EOF | tee kubelet-config.yaml.template
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: "/etc/kubernetes/cert/ca.pem"
authorization:
  mode: Webhook
clusterDomain: "${CLUSTER_DNS_DOMAIN}"
clusterDNS:
  - "${CLUSTER_DNS_SVC_IP}"
podCIDR: "${POD_CIDR}"
maxPods: 220
serializeImagePulls: false
hairpinMode: promiscuous-bridge
cgroupDriver: cgroupfs
runtimeRequestTimeout: "15m"
rotateCertificates: true
serverTLSBootstrap: true
readOnlyPort: 0
port: 10250
address: "##NODE_IP##"
EOF
```
+ addressï¼šAPI ç›‘å¬åœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ? kube-apiserverã€heapster ç­‰ä¸èƒ½è°ƒç”? kubelet çš? APIï¼?
+ readOnlyPort=0ï¼šå…³é—­åªè¯»ç«¯å?(é»˜è®¤ 10255)ï¼Œç­‰æ•ˆä¸ºæœªæŒ‡å®šï¼›
+ authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼?
+ authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš? CA è¯ä¹¦ï¼Œå¼€å? HTTP è¯ä¹¦è®¤è¯ï¼?
+ authentication.webhook.enabled=trueï¼šå¼€å? HTTPs bearer token è®¤è¯ï¼?
+ å¯¹äºæœªé?šè¿‡ x509 è¯ä¹¦å’? webhook è®¤è¯çš„è¯·æ±?(kube-apiserver æˆ–å…¶ä»–å®¢æˆ·ç«¯)ï¼Œå°†è¢«æ‹’ç»ï¼Œæç¤º Unauthorizedï¼?
+ authroization.mode=Webhookï¼škubelet ä½¿ç”¨ SubjectAccessReview API æŸ¥è¯¢ kube-apiserver æŸ? userã€group æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™?(RBAC)ï¼?
+ featureGates.RotateKubeletClientCertificateã€featureGates.RotateKubeletServerCertificateï¼šè‡ªåŠ? rotate è¯ä¹¦ï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸå–å†³äº kube-controller-manager çš? --experimental-cluster-signing-duration å‚æ•°ï¼?
+ éœ?è¦? root è´¦æˆ·è¿è¡Œï¼?

ä¸ºå„èŠ‚ç‚¹åˆ›å»ºå’Œåˆ†å? kubelet é…ç½®æ–‡ä»¶ï¼?

``` bash
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
  do 
    echo ">>> ${node_ip}"
    sed -e "s/##NODE_IP##/${node_ip}/" kubelet-config.yaml.template > kubelet-config-${node_ip}.yaml.template
    scp kubelet-config-${node_ip}.yaml.template root@${node_ip}:/etc/kubernetes/kubelet-config.yaml
  done
```

æ›¿æ¢åçš„ kubelet-config.yaml æ–‡ä»¶ï¼? [kubelet-config.yaml](https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/systemd/kubelet-config.yaml)

## åˆ›å»ºå’Œåˆ†å? kubelet systemd unit æ–‡ä»¶

åˆ›å»º kubelet systemd unit æ–‡ä»¶æ¨¡æ¿ï¼?

``` bash
cd /opt/k8s/work
cat > kubelet.service.template <<EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=docker.service
Requires=docker.service

[Service]
WorkingDirectory=${K8S_DIR}/kubelet
ExecStart=/opt/k8s/bin/kubelet \\
  --root-dir=${K8S_DIR}/kubelet \\
  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\
  --cert-dir=/etc/kubernetes/cert \\
  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
  --config=/etc/kubernetes/kubelet-config.yaml \\
  --hostname-override=##NODE_NAME## \\
  --pod-infra-container-image=registry.cn-beijing.aliyuncs.com/k8s_images/pause-amd64:3.1
  --allow-privileged=true \\
  --event-qps=0 \\
  --kube-api-qps=1000 \\
  --kube-api-burst=2000 \\
  --registry-qps=0 \\
  --image-pull-progress-deadline=30m \\
  --logtostderr=true \\
  --v=2
Restart=always
RestartSec=5
StartLimitInterval=0

[Install]
WantedBy=multi-user.target
EOF
```
+ å¦‚æœè®¾ç½®äº? `--hostname-override` é€‰é¡¹ï¼Œåˆ™ `kube-proxy` ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ? Node çš„æƒ…å†µï¼›
+ `--bootstrap-kubeconfig`ï¼šæŒ‡å? bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’? token å? kube-apiserver å‘é?? TLS Bootstrapping è¯·æ±‚ï¼?
+ K8S approve kubelet çš? csr è¯·æ±‚åï¼Œåœ? `--cert-dir` ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå†™å…¥ `--kubeconfig` æ–‡ä»¶ï¼?
+ `--pod-infra-container-image` ä¸ä½¿ç”? redhat çš? `pod-infrastructure:latest` é•œåƒï¼Œå®ƒä¸èƒ½å›æ”¶å®¹å™¨çš„åƒµå°¸ï¼›

æ›¿æ¢åçš„ unit æ–‡ä»¶ï¼š[kubelet.service](https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/systemd/kubelet.service)

ä¸ºå„èŠ‚ç‚¹åˆ›å»ºå’Œåˆ†å? kubelet systemd unit æ–‡ä»¶ï¼?

``` bash
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
for node_name in ${NODE_NAMES[@]}
  do 
    echo ">>> ${node_name}"
    sed -e "s/##NODE_NAME##/${node_name}/" kubelet.service.template > kubelet-${node_name}.service
    scp kubelet-${node_name}.service root@${node_name}:/etc/systemd/system/kubelet.service
  done
```

## Bootstrap Token Auth å’Œæˆäºˆæƒé™?

kublet å¯åŠ¨æ—¶æŸ¥æ‰¾é…ç½®çš„ --kubeletconfig æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”? --bootstrap-kubeconfig å? kube-apiserver å‘é?è¯ä¹¦ç­¾åè¯·æ±? (CSR)ã€?

kube-apiserver æ”¶åˆ° CSR è¯·æ±‚åï¼Œå¯¹å…¶ä¸­çš„ Token è¿›è¡Œè®¤è¯ï¼ˆäº‹å…ˆä½¿ç”? kubeadm åˆ›å»ºçš? tokenï¼‰ï¼Œè®¤è¯é€šè¿‡åå°†è¯·æ±‚çš? user è®¾ç½®ä¸? system:bootstrap:<Token ID>ï¼Œgroup è®¾ç½®ä¸? system:bootstrappersï¼Œè¿™ä¸?è¿‡ç¨‹ç§°ä¸º Bootstrap Token Authã€?

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ª user å’? group æ²¡æœ‰åˆ›å»º CSR çš„æƒé™ï¼Œkubelet å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š

``` bash
$ sudo journalctl -u kubelet -a |grep -A 2 'certificatesigningrequests'
May 06 06:42:36 m7-autocv-gpu01 kubelet[26986]: F0506 06:42:36.314378   26986 server.go:233] failed to run Kubelet: cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User "system:bootstrap:lemy40" cannot create certificatesigningrequests.certificates.k8s.io at the cluster scope
May 06 06:42:36 m7-autocv-gpu01 systemd[1]: kubelet.service: Main process exited, code=exited, status=255/n/a
May 06 06:42:36 m7-autocv-gpu01 systemd[1]: kubelet.service: Failed with result 'exit-code'.
```

è§£å†³åŠæ³•æ˜¯ï¼šåˆ›å»ºä¸?ä¸? clusterrolebindingï¼Œå°† group system:bootstrappers å’? clusterrole system:node-bootstrapper ç»‘å®šï¼?

``` bash
$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers
```

## å¯åŠ¨ kubelet æœåŠ¡

``` bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    ssh root@${node_ip} "mkdir -p ${K8S_DIR}/kubelet"
    ssh root@${node_ip} "/usr/sbin/swapoff -a"
    ssh root@${node_ip} "systemctl daemon-reload && systemctl enable kubelet && systemctl restart kubelet"
  done
```
+ å¿…é¡»åˆ›å»ºå·¥ä½œç›®å½•ï¼?
+ å…³é—­ swap åˆ†åŒºï¼Œå¦åˆ? kubelet ä¼šå¯åŠ¨å¤±è´¥ï¼›

```bash
$ journalctl -u kubelet |tail
8æœ? 15 12:16:49 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:49.578598    7807 feature_gate.go:230] feature gates: &{map[RotateKubeletClientCertificate:true RotateKubeletServerCertificate:true]}
8æœ? 15 12:16:49 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:49.578698    7807 feature_gate.go:230] feature gates: &{map[RotateKubeletClientCertificate:true RotateKubeletServerCertificate:true]}
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.205871    7807 mount_linux.go:214] Detected OS with systemd
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.205939    7807 server.go:408] Version: v1.11.2
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.206013    7807 feature_gate.go:230] feature gates: &{map[RotateKubeletClientCertificate:true RotateKubeletServerCertificate:true]}
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.206101    7807 feature_gate.go:230] feature gates: &{map[RotateKubeletServerCertificate:true RotateKubeletClientCertificate:true]}
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.206217    7807 plugins.go:97] No cloud provider specified.
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.206237    7807 server.go:524] No cloud provider specified: "" from the config file: ""
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.206264    7807 bootstrap.go:56] Using bootstrap kubeconfig to generate TLS client cert, key and kubeconfig file
8æœ? 15 12:16:50 m7-autocv-gpu01 kubelet[7807]: I0815 12:16:50.208628    7807 bootstrap.go:86] No valid private key and/or certificate found, reusing existing private key or creating a new one
```

kubelet å¯åŠ¨åä½¿ç”? --bootstrap-kubeconfig å? kube-apiserver å‘é?? CSR è¯·æ±‚ï¼Œå½“è¿™ä¸ª CSR è¢? approve åï¼Œkube-controller-manager ä¸? kubelet åˆ›å»º TLS å®¢æˆ·ç«¯è¯ä¹¦ã?ç§é’¥å’Œ --kubeletconfig æ–‡ä»¶ã€?

æ³¨æ„ï¼škube-controller-manager éœ?è¦é…ç½? `--cluster-signing-cert-file` å’? `--cluster-signing-key-file` å‚æ•°ï¼Œæ‰ä¼šä¸º TLS Bootstrap åˆ›å»ºè¯ä¹¦å’Œç§é’¥ã??

``` bash
$ kubectl get csr
NAME                                                   AGE       REQUESTOR                 CONDITION
node-csr--BjlTzxB5Y4op_6wYlDKbbQj1NtX-IOBMLmWhkupEWA   22s       system:bootstrap:8galm1   Pending
node-csr-a68FhmUgprTJkaLwnJOLQLOkDQuAviDdBy91ByVtWt0   28s       system:bootstrap:4ef7hj   Pending
node-csr-a7DI6d0QjBiPh58IBGYFPUKAZvKs6sfbqlnoc22erRs   27s       system:bootstrap:ai162m   Pending

$ kubectl get nodes
No resources found.
```
+ ä¸‰ä¸ª work èŠ‚ç‚¹çš? csr å‡å¤„äº? pending çŠ¶æ?ï¼›

## è‡ªåŠ¨ approve CSR è¯·æ±‚

åˆ›å»ºä¸‰ä¸ª ClusterRoleBindingï¼Œåˆ†åˆ«ç”¨äºè‡ªåŠ? approve clientã€renew clientã€renew server è¯ä¹¦ï¼?

``` bash
cd /opt/k8s/work
cat > csr-crb.yaml <<EOF
 # Approve all CSRs for the group "system:bootstrappers"
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: auto-approve-csrs-for-group
 subjects:
 - kind: Group
   name: system:bootstrappers
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
   apiGroup: rbac.authorization.k8s.io
---
 # To let a node of the group "system:nodes" renew its own credentials
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: node-client-cert-renewal
 subjects:
 - kind: Group
   name: system:nodes
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
   apiGroup: rbac.authorization.k8s.io
---
# A ClusterRole which instructs the CSR approver to approve a node requesting a
# serving cert matching its client cert.
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: approve-node-server-renewal-csr
rules:
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests/selfnodeserver"]
  verbs: ["create"]
---
 # To let a node of the group "system:nodes" renew its own server credentials
 kind: ClusterRoleBinding
 apiVersion: rbac.authorization.k8s.io/v1
 metadata:
   name: node-server-cert-renewal
 subjects:
 - kind: Group
   name: system:nodes
   apiGroup: rbac.authorization.k8s.io
 roleRef:
   kind: ClusterRole
   name: approve-node-server-renewal-csr
   apiGroup: rbac.authorization.k8s.io
EOF
```
+ auto-approve-csrs-for-groupï¼šè‡ªåŠ? approve node çš„ç¬¬ä¸?æ¬? CSRï¼? æ³¨æ„ç¬¬ä¸€æ¬? CSR æ—¶ï¼Œè¯·æ±‚çš? Group ä¸? system:bootstrappersï¼?
+ node-client-cert-renewalï¼šè‡ªåŠ? approve node åç»­è¿‡æœŸçš? client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸? system:nodes;
+ node-server-cert-renewalï¼šè‡ªåŠ? approve node åç»­è¿‡æœŸçš? server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸? system:nodes;

ç”Ÿæ•ˆé…ç½®ï¼?

``` bash
$ kubectl apply -f csr-crb.yaml
```

## æŸ¥çœ‹ kublet çš„æƒ…å†?

ç­‰å¾…ä¸?æ®µæ—¶é—?(1-10 åˆ†é’Ÿ)ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„ CSR éƒ½è¢«è‡ªåŠ¨ approvedï¼?

``` bash
$ kubectl get csr
NAME                                                   AGE       REQUESTOR                 CONDITION
node-csr--BjlTzxB5Y4op_6wYlDKbbQj1NtX-IOBMLmWhkupEWA   4m        system:bootstrap:8galm1   Approved,Issued
node-csr-a68FhmUgprTJkaLwnJOLQLOkDQuAviDdBy91ByVtWt0   4m        system:bootstrap:4ef7hj   Approved,Issued
node-csr-a7DI6d0QjBiPh58IBGYFPUKAZvKs6sfbqlnoc22erRs   4m        system:bootstrap:ai162m   Approved,Issued
```

æ‰?æœ‰èŠ‚ç‚¹å‡ readyï¼?

``` bash
$ kubectl get nodes
NAME              STATUS   ROLES    AGE     VERSION
m7-autocv-gpu03   Ready    <none>   4m12s   v1.12.3
m7-autocv-gpu02   Ready    <none>   4m13s   v1.12.3
m7-autocv-gpu01     Ready    <none>   12s     v1.12.3
```

kube-controller-manager ä¸ºå„ node ç”Ÿæˆäº? kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼?

``` bash
$ ls -l /etc/kubernetes/kubelet.kubeconfig
-rw------- 1 root root 2306 11æœ? 28 17:20 /etc/kubernetes/kubelet.kubeconfig

$ ls -l /etc/kubernetes/cert/|grep kubelet
-rw------- 1 root root 1277 11æœ? 28 17:20 kubelet-client-2018-11-28-17-20-06.pem
lrwxrwxrwx 1 root root   59 11æœ? 28 17:20 kubelet-client-current.pem -> /etc/kubernetes/cert/kubelet-client-2018-11-28-17-20-06.pem
```
+ æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ kubelet server è¯ä¹¦ï¼?

## æ‰‹åŠ¨ approve server cert csr

åŸºäº[å®‰å…¨æ€§è?ƒè™‘](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuration)ï¼ŒCSR approving controllers é»˜è®¤ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ? approveã€?


``` bash
$ kubectl get csr
NAME                                                   AGE     REQUESTOR                     CONDITION
csr-lrhk2                                              9m25s   system:node:m7-autocv-gpu03   Pending
csr-pkglb                                              5m24s   system:node:m7-autocv-gpu01     Pending
csr-xdgcl                                              9m25s   system:node:m7-autocv-gpu02   Pending
node-csr-BiCW4F3aeIQ-lQRDIRtxrK0SE967asfomI9iXKw7xFw   12m     system:bootstrap:c77gx4       Approved,Issued
node-csr-KBdQuwtHW6CgTAxtQ1PR5L0-2pL4lhH6D8z0ySeWOdg   10m     system:bootstrap:mnpn4i       Approved,Issued
node-csr-dZh_5jzWiaXVHtOd6du4aiELSDbUNQ-sDvEnSNfZtYQ   10m     system:bootstrap:em63m9       Approved,Issued

$ kubectl certificate approve csr-lrhk2
certificatesigningrequest.certificates.k8s.io/csr-lrhk2 approved

$ kubectl certificate approve csr-pkglb
certificatesigningrequest.certificates.k8s.io/csr-pkglb approved

$ kubectl certificate approve csr-xdgcl
certificatesigningrequest.certificates.k8s.io/csr-xdgcl approved

$ ls -l /etc/kubernetes/cert/kubelet-*
-rw------- 1 root root 1277 11æœ? 28 17:20 /etc/kubernetes/cert/kubelet-client-2018-11-28-17-20-06.pem
lrwxrwxrwx 1 root root   59 11æœ? 28 17:20 /etc/kubernetes/cert/kubelet-client-current.pem -> /etc/kubernetes/cert/kubelet-client-2018-11-28-17-20-06.pem
-rw------- 1 root root 1326 11æœ? 28 17:25 /etc/kubernetes/cert/kubelet-server-2018-11-28-17-25-44.pem
lrwxrwxrwx 1 root root   59 11æœ? 28 17:25 /etc/kubernetes/cert/kubelet-server-current.pem -> /etc/kubernetes/cert/kubelet-server-2018-11-28-17-25-44.pem
```

## kubelet æä¾›çš? API æ¥å£

kublet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒç»„ä»¶å‘é€çš„è¯·æ±‚ï¼?

``` bash
$ sudo netstat -lnpt|grep kubelet
tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      73487/kubelet
tcp        0      0 192.168.1.88:10250    0.0.0.0:*               LISTEN      73487/kubelet
```
+ 10248: healthz http æœåŠ¡ï¼?
+ 10250: https API æœåŠ¡ï¼›æ³¨æ„ï¼šæœªå¼€å¯åªè¯»ç«¯å? 10255ï¼?

ä¾‹å¦‚æ‰§è¡Œ `kubectl exec -it nginx-ds-5rmws -- sh` å‘½ä»¤æ—¶ï¼Œkube-apiserver ä¼šå‘ kubelet å‘é?å¦‚ä¸‹è¯·æ±‚ï¼š

    POST /exec/default/nginx-ds-5rmws/my-nginx?command=sh&input=1&output=1&tty=1

kubelet æ¥æ”¶ 10250 ç«¯å£çš? https è¯·æ±‚ï¼?

+ /podsã€?/runningpods
+ /metricsã€?/metrics/cadvisorã€?/metrics/probes
+ /spec
+ /statsã€?/stats/container
+ /logs
+ /run/ã€?"/exec/", "/attach/", "/portForward/", "/containerLogs/" ç­‰ç®¡ç†ï¼›

è¯¦æƒ…å‚è?ƒï¼šhttps://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3

ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼?å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—? 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ?è¦è¢«è®¤è¯å’Œæˆæƒã??

é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰?æœ? API çš„æƒé™?(kube-apiserver ä½¿ç”¨çš? kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼?

``` bash
$ kubectl describe clusterrole system:kubelet-api-admin
Name:         system:kubelet-api-admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate=true
PolicyRule:
  Resources      Non-Resource URLs  Resource Names  Verbs
  ---------      -----------------  --------------  -----
  nodes          []                 []              [get list watch proxy]
  nodes/log      []                 []              [*]
  nodes/metrics  []                 []              [*]
  nodes/proxy    []                 []              [*]
  nodes/spec     []                 []              [*]
  nodes/stats    []                 []              [*]
```

## kublet api è®¤è¯å’Œæˆæ?

kublet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°ï¼š

+ authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼?
+ authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš? CA è¯ä¹¦ï¼Œå¼€å? HTTPs è¯ä¹¦è®¤è¯ï¼?
+ authentication.webhook.enabled=trueï¼šå¼€å? HTTPs bearer token è®¤è¯ï¼?

åŒæ—¶é…ç½®äº†å¦‚ä¸‹æˆæƒå‚æ•°ï¼š

+ authroization.mode=Webhookï¼šå¼€å? RBAC æˆæƒï¼?

kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è?…æŸ¥è¯? bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é?šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤? Unauthorizedï¼?

``` bash
$ curl -s --cacert /etc/kubernetes/cert/ca.pem https://192.168.1.187:10250/metrics
Unauthorized

$ curl -s --cacert /etc/kubernetes/cert/ca.pem -H "Authorization: Bearer 123456" https://192.168.1.187:10250/metrics
Unauthorized
```

é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å? kube-apiserver å‘é?è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ? token å¯¹åº”çš? userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼?

### è¯ä¹¦è®¤è¯å’Œæˆæ?

``` bash
$ # æƒé™ä¸è¶³çš„è¯ä¹¦ï¼›
$ sudo curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /etc/kubernetes/cert/kube-controller-manager.pem --key /etc/kubernetes/cert/kube-controller-manager-key.pem https://192.168.1.187:10250/metrics
Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)

$ # ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã?å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼?
$ sudo curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://192.168.1.187:10250/metrics|head
# HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.
# TYPE apiserver_client_certificate_expiration_seconds histogram
apiserver_client_certificate_expiration_seconds_bucket{le="0"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="21600"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="43200"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="86400"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="172800"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="345600"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="604800"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="2.592e+06"} 0
```
+ `--cacert`ã€`--cert`ã€`--key` çš„å‚æ•°å?¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸Šé¢çš? `./admin.pem` ä¸èƒ½çœç•¥ `./`ï¼Œå¦åˆ™è¿”å›? `401 Unauthorized`ï¼?

### bear token è®¤è¯å’Œæˆæ?

åˆ›å»ºä¸?ä¸? ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”? kubelet API çš„æƒé™ï¼š

``` bash
kubectl create sa kubelet-api-test
kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test
SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '{print $1}')
TOKEN=$(kubectl describe secret ${SECRET} | grep -E '^token' | awk '{print $2}')
echo ${TOKEN}

$ curl -s --cacert /etc/kubernetes/cert/ca.pem -H "Authorization: Bearer ${TOKEN}" https://192.168.1.187:10250/metrics|head
# HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.
# TYPE apiserver_client_certificate_expiration_seconds histogram
apiserver_client_certificate_expiration_seconds_bucket{le="0"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="21600"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="43200"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="86400"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="172800"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="345600"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="604800"} 0
apiserver_client_certificate_expiration_seconds_bucket{le="2.592e+06"} 0
```

### cadvisor å’? metrics

cadvisor ç»Ÿè®¡æ‰?åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº?(CPUã€å†…å­˜ã?ç£ç›˜ã?ç½‘å?)ä½¿ç”¨æƒ…å†µï¼Œåˆ†åˆ«åœ¨è‡ªå·±çš? http web é¡µé¢(4194 ç«¯å£)å’? 10250 ä»? promehteus metrics çš„å½¢å¼è¾“å‡ºã??

æµè§ˆå™¨è®¿é—? https://172.27.129.149:10250/metrics å’? https://172.27.129.149:10250/metrics/cadvisor åˆ†åˆ«è¿”å› kublet å’? cadvisor çš? metricsã€?

![cadvisor-metrics](images/cadvisor-metrics.png)

æ³¨æ„ï¼?

+ kublet.config.json è®¾ç½® authentication.anonymous.enabled ä¸? falseï¼Œä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš? https æœåŠ¡ï¼?
+ å‚è?ƒ[A.æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£.md](A.æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£.md)ï¼Œåˆ›å»ºå’Œå¯¼å…¥ç›¸å…³è¯ä¹¦ï¼Œç„¶åè®¿é—®ä¸Šé¢çš„ 10250 ç«¯å£ï¼?

## è·å– kublet çš„é…ç½?

ä»? kube-apiserver è·å–å? node çš„é…ç½®ï¼š

``` bash
$ # ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã?å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼?
$ source /opt/k8s/bin/environment.sh
$ sudo curl -sSL --cacert /etc/kubernetes/cert/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem ${KUBE_APISERVER}/api/v1/nodes/m7-autocv-gpu01/proxy/configz | jq \
  '.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'
{
  "syncFrequency": "1m0s",
  "fileCheckFrequency": "20s",
  "httpCheckFrequency": "20s",
  "address": "192.168.1.88",
  "port": 10250,
  "rotateCertificates": true,
  "serverTLSBootstrap": true,
  "authentication": {
    "x509": {
      "clientCAFile": "/etc/kubernetes/cert/ca.pem"
    },
    "webhook": {
      "enabled": true,
      "cacheTTL": "2m0s"
    },
    "anonymous": {
      "enabled": false
    }
  },
  "authorization": {
    "mode": "Webhook",
    "webhook": {
      "cacheAuthorizedTTL": "5m0s",
      "cacheUnauthorizedTTL": "30s"
    }
  },
  "registryPullQPS": 5,
  "registryBurst": 10,
  "eventRecordQPS": 5,
  "eventBurst": 10,
  "enableDebuggingHandlers": true,
  "healthzPort": 10248,
  "healthzBindAddress": "127.0.0.1",
  "oomScoreAdj": -999,
  "clusterDomain": "cluster.local",
  "clusterDNS": [
    "10.254.0.2"
  ],
  "streamingConnectionIdleTimeout": "4h0m0s",
  "nodeStatusUpdateFrequency": "10s",
  "imageMinimumGCAge": "2m0s",
  "imageGCHighThresholdPercent": 85,
  "imageGCLowThresholdPercent": 80,
  "volumeStatsAggPeriod": "1m0s",
  "cgroupsPerQOS": true,
  "cgroupDriver": "cgroupfs",
  "cpuManagerPolicy": "none",
  "cpuManagerReconcilePeriod": "10s",
  "runtimeRequestTimeout": "2m0s",
  "hairpinMode": "promiscuous-bridge",
  "maxPods": 2000,
  "podPidsLimit": -1,
  "resolvConf": "/etc/resolv.conf",
  "cpuCFSQuota": true,
  "maxOpenFiles": 1000000,
  "contentType": "application/vnd.kubernetes.protobuf",
  "kubeAPIQPS": 5,
  "kubeAPIBurst": 10,
  "serializeImagePulls": false,
  "evictionHard": {
    "imagefs.available": "15%",
    "memory.available": "100Mi",
    "nodefs.available": "10%",
    "nodefs.inodesFree": "5%"
  },
  "evictionPressureTransitionPeriod": "5m0s",
  "enableControllerAttachDetach": true,
  "makeIPTablesUtilChains": true,
  "iptablesMasqueradeBit": 14,
  "iptablesDropBit": 15,
  "featureGates": {
    "RotateKubeletClientCertificate": true,
    "RotateKubeletServerCertificate": true
  },
  "failSwapOn": true,
  "containerLogMaxSize": "10Mi",
  "containerLogMaxFiles": 5,
  "enforceNodeAllocatable": [
    "pods"
  ],
  "kind": "KubeletConfiguration",
  "apiVersion": "kubelet.config.k8s.io/v1beta1"
}
```

æˆ–è?…å‚è€ƒä»£ç ä¸­çš„æ³¨é‡Šï¼šhttps://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/apis/kubeletconfig/v1beta1/types.go

## å‚è??
1. kubelet è®¤è¯å’Œæˆæƒï¼šhttps://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/